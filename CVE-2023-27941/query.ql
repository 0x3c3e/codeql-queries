/**
 * @name DTrace Out-of-bounds Read
 * @description DTrace uses user-controllable value as list index.
 * @kind problem
 * @problem.severity warning
 * @id apple-xnu/cpp/dtrace-unsafe-index-cve-2023-27941
 */

import cpp

from GEExpr ge, Variable arg
where
  ge.getLeftOperand() = arg.getAnAccess() and
  ge.getLeftOperand().getExplicitlyConverted().getUnderlyingType().(IntegralType).isSigned() and
  ge.getRightOperand().getExplicitlyConverted().getUnderlyingType().(IntegralType).isUnsigned() and
  not exists(RelationalOperation ro |
    ro.getLeftOperand() = arg.getAnAccess() and
    ro.getRightOperand().getValue() = "0"
  )
select ge, ge.getEnclosingFunction(), ge.getLocation().getFile().getShortName()
